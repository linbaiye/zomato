<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Restaurant">
	<select id="selectCategoryCountMap" resultType="Map">
	select (select count(distinct(l.rid)) from restaurant_keywords l left join keywords r on l.kid = r.id where r.name = 'Pub') as alcohol,
	(select count(distinct(l.rid)) from restaurant_keywords l left join keywords r on l.kid = r.id where r.name = 'Dessert Parlour') as dessert,
	(select count(distinct(l.rid)) from restaurant_keywords l left join keywords r on l.kid = r.id where r.name = 'Fine Dining' or r.name = 'Casual Dining') as dining,
	(select count(distinct(l.rid)) from restaurant_keywords l left join keywords r on l.kid = r.id where r.name = 'Fast Food') as fast,
	(select count(distinct(l.rid)) from restaurant_keywords l left join keywords r on l.kid = r.id where r.name = 'Café') as cafe,
	(select count(*) from restaurant) as magic
	</select>
	<select id="selectRecommendUrls" resultType="Map">
		(select 'pub' as name, thumb_img_url as url, id from restaurant where id = 
			(select distinct(l.rid) from restaurant_keywords l left join keywords r on l.kid = r.id 
			where r.name = 'Pub' limit 1 offset #{alcohol})) union 
		(select 'dessert' as name, thumb_img_url as url, id from restaurant where id = 
			(select distinct(l.rid) from restaurant_keywords l left join keywords r on l.kid = r.id 
			where r.name = 'Dessert Parlour' limit 1 offset #{dessert})) union
		(select 'dining' as name, thumb_img_url as url, id from restaurant where id = 
			(select distinct(l.rid) from restaurant_keywords l left join keywords r on l.kid = r.id 
			where r.name = 'Fine Dining' or r.name = 'Casual Dining' limit 1 offset #{dining})) union
		(select 'fast' as name, thumb_img_url as url, id from restaurant where id = 
			(select distinct(l.rid) from restaurant_keywords l left join keywords r on l.kid = r.id 
			where r.name = 'Fast Food' limit 1 offset #{fast})) union
		(select 'cafe' as name, thumb_img_url as url, id from restaurant where id = 
			(select distinct(l.rid) from restaurant_keywords l left join keywords r on l.kid = r.id 
			where r.name = 'Café' limit 1 offset #{cafe})) union
		(select 'magic' as name, thumb_img_url as url, id from restaurant limit 1 offset #{magic})
	</select>
	<select id="selectStatistic" resultType="Map">
		select d.district, t.count from (select did, count(did) as count from restaurant group by 
			did order by count desc limit 30) as t left join district_info d on t.did = d.id
	</select>
	<select id="selectRestrauntsByType" resultMap="restaurantMap">
		select h.name highlight, r.name name, c.name cuisine, d.district, r.address, r.phone, r.rate, r.img_url, r.known_for, r.approx_price, 
		r.thumb_img_url, k.name keyword from restaurant r left join district_info d on r.did = d.id left join restaurant_keywords rk 
		on r.id = rk.rid left join keywords k on rk.kid = k.id left join restaurant_cuisines rc on rc.rid = r.id left join cuisines c 
		on rc.cid = c.id left join restaurant_highlights rh on rh.rid = r.id left join highlights h on rh.hid = h.id where k. 
	</select>
	<select id="selectRestaurant" resultMap="restaurantMap">
		select h.name highlight, r.name name, c.name cuisine, d.district, r.address, r.phone, r.rate, r.img_url, r.known_for, r.approx_price, 
		r.thumb_img_url, k.name keyword from restaurant r left join district_info d on r.did = d.id left join restaurant_keywords rk 
		on r.id = rk.rid left join keywords k on rk.kid = k.id left join restaurant_cuisines rc on rc.rid = r.id left join cuisines c 
		on rc.cid = c.id left join restaurant_highlights rh on rh.rid = r.id left join highlights h on rh.hid = h.id where r.id = #{id}
	</select>
	<resultMap id="restaurantMap" type="org.nalby.zomato.model.Restaurant">
		<id property="name"	column="name"/>
		<result property="district" column="district"/>
		<result property="address" column="address"/>
		<result property="phone" column="phone"/>
		<result property="rate" column="rate"/>
		<result property="imageUrl" column="img_url"/>
		<result property="knownFor" column="known_for"/>
		<result property="approxPrice" column="approx_price"/>
		<result property="thumbImageUrl" column="thumb_img_url"/>
		<association property="keywords" resultMap="keywordMap"/>
		<association property="cuisines" resultMap="cusineMap"/>
		<association property="highlights" resultMap="highlightMap"/>
	</resultMap>
	<resultMap type="String" id="keywordMap">
		<result property="keywords"	column="keyword"/>
	</resultMap>
	<resultMap type="String" id="cusineMap">
		<result property="cuisines"	column="cuisine"/>
	</resultMap>
	<resultMap type="String" id="highlightMap">
		<result property="highlights" column="highlight"/>
	</resultMap>
</mapper>